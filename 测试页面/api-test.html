<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIè°ƒç”¨æµ‹è¯• - ç¾å›¢å¤–å–æ•°æ®åˆ†æ</title>
    
    <!-- Tailwind CSS + DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-base-200 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <div class="navbar bg-base-100 shadow-lg">
        <div class="flex-1">
            <a class="btn btn-ghost text-xl">ğŸ§ª APIè°ƒç”¨æµ‹è¯•</a>
        </div>
        <div class="flex-none">
            <a href="index.html" class="btn btn-outline btn-sm mr-2">è¿”å›ä¸»é¡µ</a>
            <a href="funnel-test.html" class="btn btn-primary btn-sm">è½¬åŒ–æ¼æ–—æµ‹è¯•</a>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        
        <!-- APIé…ç½®æ˜¾ç¤º -->
        <div class="card bg-base-100 shadow-xl mb-8">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-4">ğŸ”§ å½“å‰APIé…ç½®</h2>
                <div class="bg-base-200 p-4 rounded-lg">
                    <pre id="apiConfig" class="text-sm"></pre>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•æŒ‰é’® -->
        <div class="card bg-base-100 shadow-xl mb-8">
            <div class="card-body">
                <h2 class="card-title text-xl mb-4">ğŸš€ APIæµ‹è¯•</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button class="btn btn-primary" onclick="testBasicConnection()">
                        æµ‹è¯•åŸºç¡€è¿æ¥
                    </button>
                    <button class="btn btn-secondary" onclick="testTextAnalysis()">
                        æµ‹è¯•æ–‡æœ¬åˆ†æ
                    </button>
                    <button class="btn btn-accent" onclick="testImageAnalysis()">
                        æµ‹è¯•å›¾ç‰‡åˆ†æ
                    </button>
                    <button class="btn btn-info" onclick="testFunnelPrompt()">
                        æµ‹è¯•è½¬åŒ–æ¼æ–—æç¤ºè¯
                    </button>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•ç»“æœ -->
        <div class="card bg-base-100 shadow-xl" id="testResults" style="display: none;">
            <div class="card-body">
                <h2 class="card-title text-xl mb-4">ğŸ“‹ æµ‹è¯•ç»“æœ</h2>
                <div id="testResultsContent">
                    <!-- æµ‹è¯•ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div class="card bg-base-100 shadow-xl" id="loadingSection" style="display: none;">
            <div class="card-body text-center">
                <div class="loading loading-spinner loading-lg mb-4"></div>
                <p class="text-lg" id="loadingText">æ­£åœ¨æµ‹è¯•APIè¿æ¥...</p>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/api.js"></script>
    
    <script>
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºAPIé…ç½®
        document.addEventListener('DOMContentLoaded', function() {
            displayAPIConfig();
        });

        function displayAPIConfig() {
            const configElement = document.getElementById('apiConfig');
            if (typeof API_CONFIG !== 'undefined') {
                const displayConfig = {
                    baseUrl: API_CONFIG.baseUrl,
                    model: API_CONFIG.model,
                    temperature: API_CONFIG.temperature,
                    max_tokens: API_CONFIG.max_tokens,
                    timeout: API_CONFIG.timeout,
                    apiKey: API_CONFIG.apiKey ? `${API_CONFIG.apiKey.substring(0, 15)}...` : 'æœªé…ç½®'
                };
                configElement.textContent = JSON.stringify(displayConfig, null, 2);
            } else {
                configElement.textContent = 'APIé…ç½®æœªåŠ è½½';
            }
        }

        function showLoading(text = 'æ­£åœ¨æµ‹è¯•...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('testResults').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingSection').style.display = 'none';
        }

        function showResults(title, result, isSuccess = true) {
            hideLoading();
            
            const resultsDiv = document.getElementById('testResults');
            const contentDiv = document.getElementById('testResultsContent');

            let html = `<div class="space-y-4">`;
            
            // æ ‡é¢˜å’ŒçŠ¶æ€
            html += `<div class="alert ${isSuccess ? 'alert-success' : 'alert-error'}">`;
            html += `<span>${isSuccess ? 'âœ…' : 'âŒ'} ${title}</span>`;
            html += '</div>';

            // ç»“æœå†…å®¹
            if (typeof result === 'object') {
                html += `<div class="bg-base-200 p-4 rounded-lg">`;
                html += `<h4 class="font-semibold mb-2">è¯¦ç»†ç»“æœï¼š</h4>`;
                html += `<pre class="text-xs overflow-auto max-h-96">${JSON.stringify(result, null, 2)}</pre>`;
                html += '</div>';
            } else {
                html += `<div class="bg-base-200 p-4 rounded-lg">`;
                html += `<p class="text-sm">${result}</p>`;
                html += '</div>';
            }

            html += '</div>';
            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        async function testBasicConnection() {
            showLoading('æµ‹è¯•åŸºç¡€APIè¿æ¥...');
            
            try {
                const api = new GeminiAPI();
                const result = await api.testConnection();
                
                if (result.success) {
                    showResults('åŸºç¡€è¿æ¥æµ‹è¯•æˆåŠŸ', result, true);
                } else {
                    showResults('åŸºç¡€è¿æ¥æµ‹è¯•å¤±è´¥', result, false);
                }
            } catch (error) {
                console.error('åŸºç¡€è¿æ¥æµ‹è¯•å‡ºé”™:', error);
                showResults('åŸºç¡€è¿æ¥æµ‹è¯•å‡ºé”™', { error: error.message }, false);
            }
        }

        async function testTextAnalysis() {
            showLoading('æµ‹è¯•æ–‡æœ¬åˆ†æåŠŸèƒ½...');
            
            try {
                const api = new GeminiAPI();
                
                // æ„å»ºç®€å•çš„æ–‡æœ¬åˆ†æè¯·æ±‚
                const requestBody = {
                    model: api.model,
                    messages: [
                        {
                            role: "user",
                            content: "è¯·ç®€å•åˆ†æä¸€ä¸‹ï¼šæŸé¤å…æ˜¨æ—¥è®¢å•100å•ï¼Œä»Šæ—¥è®¢å•120å•ã€‚"
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 500
                };

                const response = await fetch(api.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${api.apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                showResults('æ–‡æœ¬åˆ†ææµ‹è¯•æˆåŠŸ', result, true);

            } catch (error) {
                console.error('æ–‡æœ¬åˆ†ææµ‹è¯•å‡ºé”™:', error);
                showResults('æ–‡æœ¬åˆ†ææµ‹è¯•å¤±è´¥', { error: error.message }, false);
            }
        }

        async function testImageAnalysis() {
            showLoading('æµ‹è¯•å›¾ç‰‡åˆ†æåŠŸèƒ½...');
            
            try {
                // åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•å›¾ç‰‡ï¼ˆ1x1åƒç´ çš„PNGï¼‰
                const canvas = document.createElement('canvas');
                canvas.width = 1;
                canvas.height = 1;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#FF0000';
                ctx.fillRect(0, 0, 1, 1);
                const testImageBase64 = canvas.toDataURL('image/png');

                const api = new GeminiAPI();
                const storeInfo = {
                    name: 'æµ‹è¯•åº—é“º',
                    category: 'ä¸­å¼å¿«é¤',
                    address: 'æµ‹è¯•åœ°å€'
                };

                const result = await api.analyzeImage(testImageBase64, storeInfo);
                showResults('å›¾ç‰‡åˆ†ææµ‹è¯•å®Œæˆ', result, !result.error);

            } catch (error) {
                console.error('å›¾ç‰‡åˆ†ææµ‹è¯•å‡ºé”™:', error);
                showResults('å›¾ç‰‡åˆ†ææµ‹è¯•å¤±è´¥', { error: error.message }, false);
            }
        }

        async function testFunnelPrompt() {
            showLoading('æµ‹è¯•è½¬åŒ–æ¼æ–—æç¤ºè¯...');
            
            try {
                const api = new GeminiAPI();
                const storeInfo = {
                    name: 'æµ‹è¯•åº—é“º',
                    category: 'ä¸­å¼å¿«é¤',
                    address: 'åŒ—äº¬å¸‚æœé˜³åŒº'
                };

                const prompt = api.buildAnalysisPrompt(storeInfo);
                
                showResults('è½¬åŒ–æ¼æ–—æç¤ºè¯ç”ŸæˆæˆåŠŸ', {
                    promptLength: prompt.length,
                    storeInfo: storeInfo,
                    promptPreview: prompt.substring(0, 500) + '...'
                }, true);

            } catch (error) {
                console.error('æç¤ºè¯æµ‹è¯•å‡ºé”™:', error);
                showResults('æç¤ºè¯æµ‹è¯•å¤±è´¥', { error: error.message }, false);
            }
        }
    </script>
</body>
</html>
